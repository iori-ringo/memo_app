# システムアーキテクチャ図 draw.io 作成プラン

## 概要

Magic Memo の C4 L2 Container Diagram をdraw.io (XML形式) で作成する。
5層のレイヤー構造を可視化し、IPC通信・データフロー・型共有の全体像を1枚の図で把握できるようにする。

## 背景・動機

- プロジェクトにアーキテクチャ図が存在しない
- Electron + Next.js のクロスプラットフォーム構成が複雑で、新規参画者の理解コストが高い
- CLAUDE.md に C4 Model / draw.io ルールが定義済みであり、それに準拠した図を作成する好機

## 技術スタック

- **構成図**: draw.io (XML形式, `.drawio`)
- **対象アプリ**: Electron 39 + Next.js 16 + React 19 + TypeScript
- **C4 Model Level**: L2 (Container)

## 実装方針

### 出力ファイル

```
docs/architecture.drawio
```

### CLAUDE.md 準拠ルール

| ルール | 対応 |
|--------|------|
| `<mxfile>` ラッパー使用 | XML テンプレートに従う |
| `diagram name="L2-..."` 形式 | `L2-Container Diagram` |
| タイトル・凡例・作成日 | 図内に含める (`2026-02-27`) |
| フォント | 日本語「Noto Sans JP」/ 英語「Inter」 |
| `parent` によるグルーピング | レイヤーコンテナに子要素を配置 |
| レイアウト方向 TB | 上から下 |
| 矢印ラベルに通信プロトコル | `IPC/invoke`, `HTTPS/JSON`, `webContents.send` 等 |
| 境界線のみ C4 カラー | 青=共有, 紫=Desktop固有, 橙=外部 |
| 背景白・文字黒 | ユーザー指定 |
| AWS アイコン積極利用 | `mxgraph.aws4.*` を視覚的メタファーとして割当 |
| XML 整形済み | pretty-printed 出力 |

### 図の構成: 5層レイヤー

```
┌─────────────────────────────────────────────────────────┐
│  Layer 1: React/Next.js Frontend (境界線: 青)           │
│                                                         │
│  ┌─App Router──┐  ┌─notebook─┐ ┌─notes──┐ ┌─sidebar─┐ │
│  │ [Amplify]   │  │[AppSync] │ │[Cache] │ │[Console]│ │
│  │layout.tsx   │  │Canvas    │ │Zustand │ │AppSidebar│ │
│  │page.tsx     │  │TextBlock │ │Store   │ │Search   │ │
│  └─────────────┘  │Hooks x4  │ │useNotes│ │Grouping │ │
│                    └──────────┘ └────────┘ └─────────┘ │
│  ┌─Shared (shadcn/ui) [CloudFormation]────────────┐    │
│  │ Button, Card, Sheet, DropdownMenu, ThemeProvider│    │
│  └─────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────┤
│  Layer 2: Platform Adapter (境界線: 青)                 │
│  [API Gateway] note-storage.ts / platform-events.ts     │
├─────────────────────────────────────────────────────────┤
│  Layer 3: Electron Preload Bridge (境界線: 紫)          │
│  [WAF] contextBridge (electronAPI)                      │
│  Security: contextIsolation / sandbox                   │
├─────────────────────────────────────────────────────────┤
│  Layer 4: Electron Main Process (境界線: 紫)            │
│  [EC2] main.ts                                          │
│  ┌─[Lambda]──────┐ ┌─[SageMaker]──┐ ┌─[CloudFront]─┐  │
│  │Data Handlers  │ │AI Handlers   │ │Window Mgmt   │  │
│  │load/save pages│ │generate-*    │ │main-window   │  │
│  │+ [Inspector]  │ │              │ │menu.ts       │  │
│  └───────────────┘ └──────────────┘ └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│  Layer 5: Storage & External Services                   │
│  ┌─[DynamoDB]────┐ ┌─[S3]────────┐ ┌─[Cloud]──────┐  │
│  │electron-store │ │localStorage │ │Gemini API    │  │
│  │(境界線:紫)    │ │(境界線:青)  │ │(境界線:橙)   │  │
│  └───────────────┘ └─────────────┘ └──────────────┘  │
└─────────────────────────────────────────────────────────┘
  右サイド: [CodeArtifact] Type System (SSoT) - note.d.ts
```

### AWS アイコンマッピング

| コンポーネント | AWS アイコン | 理由 |
|--------------|-------------|------|
| Next.js App Router | Amplify | Webアプリホスティング |
| Notebook Canvas | AppSync | リアルタイムUI同期 |
| Zustand Store | ElastiCache | インメモリ状態管理 |
| Sidebar | Management Console | ナビゲーション |
| Shared UI (shadcn) | CloudFormation | UIコンポーネントテンプレート |
| Platform Adapter | API Gateway | 抽象化レイヤー |
| Preload Bridge | WAF | セキュリティ境界 |
| Electron Main | EC2 | メインプロセス |
| Data Handlers | Lambda | 関数ハンドラー |
| AI Handlers | SageMaker | AI/ML処理 |
| Window Management | CloudFront | コンテンツ配信 |
| Validators | Inspector | 入力検証 |
| electron-store | DynamoDB | キーバリューストア |
| localStorage | S3 | オブジェクトストレージ |
| Gemini API | General AWS Cloud | 外部クラウドサービス |
| Type System (SSoT) | CodeArtifact | 型パッケージ共有 |

### 接続線（通信プロトコル明記）

| From | To | ラベル | スタイル |
|------|----|--------|---------|
| Zustand Store | note-storage.ts | `subscribe/auto-save` | 実線 |
| note-storage.ts | contextBridge | `IPC/invoke` | 実線 |
| note-storage.ts | localStorage | `Web Storage API` | 実線 |
| contextBridge | Data Handlers | `ipcMain.handle` | 実線 |
| contextBridge | AI Handlers | `ipcMain.handle` | 実線 |
| Data Handlers | electron-store | `JSON file read/write` | 実線 |
| AI Handlers | Gemini API | `HTTPS/JSON` | 実線 |
| menu.ts | contextBridge | `webContents.send` | 破線 |
| contextBridge | platform-events.ts | `ipcRenderer.on` | 破線 |
| note.d.ts | 各レイヤー | `type import` | 点線・グレー |

### カラースキーム

白背景・黒文字。C4 カラーは境界線のみ:

| 区分 | 境界線色 | 適用先 |
|------|---------|--------|
| 共有レイヤー | `#1565C0` (青) | Frontend, Platform Adapter, localStorage |
| Desktop固有 | `#6A1B9A` (紫) | Preload, Main Process, electron-store |
| 外部サービス | `#E65100` (橙) | Gemini AI API |

### 凡例（図内に含める）

- タイトル: `Magic Memo — L2 Container Diagram`
- 作成日: `2026-02-27`
- 矢印凡例: 実線=データフロー / 破線=イベントフロー / 点線(グレー)=型共有
- 境界線色凡例: 青=共有 / 紫=Desktop固有 / 橙=外部

## タスク分解

- [ ] `docs/` ディレクトリ作成
- [ ] draw.io XML 骨格作成（`<mxfile>` + `<diagram>` + `<mxGraphModel>`）
- [ ] Layer 1: Frontend レイヤーのノード配置（AWS アイコン付き）
- [ ] Layer 2: Platform Adapter ノード配置
- [ ] Layer 3: Preload Bridge ノード配置
- [ ] Layer 4: Main Process ノード配置
- [ ] Layer 5: Storage & External ノード配置
- [ ] Type System (SSoT) パネル配置
- [ ] 接続線（通信プロトコルラベル付き）の追加
- [ ] 凡例パネルの追加
- [ ] `docs/architecture.drawio` として保存
- [ ] draw.io で開いて視覚的に検証
- [ ] CLAUDE.md 準拠チェック実施

## 懸念点・検討事項

- **AWS アイコンの表示**: `mxgraph.aws4.*` の shape 値が draw.io バージョンにより異なる可能性がある。表示されない場合は汎用シェイプにフォールバック
- **図のサイズ**: 全コンポーネントを1枚に収めると情報過多になる可能性。L2レベルに留め、詳細は必要に応じてL3図を別途作成
- **フォント**: Noto Sans JP / Inter がインストールされていない環境では代替フォントで表示される

## 参考リンク

- `CLAUDE.md` — C4 Model Rules / draw.io Rules / Architecture Principles
- `ai-docs/20260221-notebook-リファクタリング-ベストプラクティス準拠.md` — 関連するリファクタリングプラン
